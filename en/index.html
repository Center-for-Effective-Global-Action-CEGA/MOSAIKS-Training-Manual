<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<p>This is the first edition of the MOSAIKS Training Manual! The manual serves as a comprehensive reference for understanding MOSAIKS, its capabilities, and guidance on practical implementation. You will learn what MOSAIKS is, what can be done with it, and how to use it effectively in a variety of applications.</p>
<p>The skills and knowledge you gain from this manual will enable you to leverage satellite imagery and machine learning to address complex socioeconomic and environmental challenges. This can be a self taught manual or used in conjunction with a training course.</p>
<p>Many of the concepts and examples are broadly applicable to the world of remote sensing and machine learning, so even if you are not using MOSAIKS, you may find the content useful.</p>
<section id="what-is-mosaiks" class="level2">
<h2 class="anchored" data-anchor-id="what-is-mosaiks">What is MOSAIKS?</h2>
<p>MOSAIKS stands for <strong><ins>M</ins>ulti-task <ins>O</ins>bservation using <ins>SA</ins>tellite <ins>I</ins>magery &amp; <ins>K</ins>itchen <ins>S</ins>inks</strong>. It is a framework designed to simplify the use of satellite imagery and machine learning for predicting socioeconomic and environmental outcomes across different geographic contexts and time periods. MOSAIKS relis on random convolutions (developed in Rahimi and Recht (2008)) applied to satellite imagery, which extract task-agnostic features and enable researchers and practitioners to easily and flexibly predict a diversity of outcomes from raw imagery.</p>
<div id="fig-mosaiks-in-landsat" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosaiks-in-landsat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/mosaiks-in-landsat.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosaiks-in-landsat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: MOSAIKS spelled out with imagery from the Landsat Satellite Constellation data catalog. Made with: <a href="https://landsat.gsfc.nasa.gov/apps/YourNameInLandsat-main/">Your Name in Landsat</a>
</figcaption>
</figure>
</div>
</section>
<section id="who-is-this-for" class="level2">
<h2 class="anchored" data-anchor-id="who-is-this-for">Who is this for?</h2>
<p>This comprehensive two-week program is designed for academics, professionals, and practitioners interested in leveraging MOSAIKS to better understand socioeconomic and environmental challenges. The course is particularly valuable for those working in:</p>
<ul>
<li>Remote sensing and satellite imagery analysis</li>
<li>Machine learning applications with geospatial data</li>
<li>Agricultural and environmental monitoring and assessment</li>
<li>Development research and policy making</li>
</ul>
</section>
<section id="what-will-i-learn" class="level2">
<h2 class="anchored" data-anchor-id="what-will-i-learn">What will I learn?</h2>
<p>Throughout this course, you’ll learn practical applications through a combination of:</p>
<ul>
<li>Theoretical foundations and conceptual understanding</li>
<li>Hands-on exercises with real-world data</li>
<li>Best practices for implementation</li>
<li>Strategies for analyzing and interpreting results</li>
</ul>
<p>The curriculum covers the complete MOSAIKS workflow, including:</p>
<ul>
<li>Accessing and processing satellite imagery</li>
<li>Understanding MOSAIKS feature extraction</li>
<li>Working with the MOSAIKS API</li>
<li>Implementing machine learning models</li>
<li>Quantifying and communicating uncertainty</li>
<li>Applying models to various contexts</li>
<li>Working with survey data</li>
</ul>
<p>Whether you’re new to MOSAIKS or looking to deepen your expertise, this course provides the tools and knowledge needed to effectively utilize this framework.</p>
</section>
<section id="course-structure" class="level2">
<h2 class="anchored" data-anchor-id="course-structure">Course structure</h2>
<p>This course is designed as an intensive two-week program that combines lectures, demonstrations, and hands-on sessions. Each day is structured as follows:</p>
<div id="tbl-course-outline" class="striped hover quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-course-outline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Daily time divisions showing 2 morning sessions, 2 afternoon sessions, and a final time slot alloted for developing the course further.
</figcaption>
<div aria-describedby="tbl-course-outline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-striped table-hover caption-top table">
<thead>
<tr class="header">
<th><strong>Time</strong></th>
<th style="text-align: left;"><strong>Activity</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>9:00 - 10:30</td>
<td style="text-align: left;">Morning Session 1</td>
</tr>
<tr class="even">
<td>10:30 - 11:00</td>
<td style="text-align: left;">Break</td>
</tr>
<tr class="odd">
<td>11:00 - 12:30</td>
<td style="text-align: left;">Morning Session 2</td>
</tr>
<tr class="even">
<td>12:30 - 1:30</td>
<td style="text-align: left;">Lunch</td>
</tr>
<tr class="odd">
<td>1:30 - 3:00</td>
<td style="text-align: left;">Afternoon Session 1</td>
</tr>
<tr class="even">
<td>3:00 - 3:30</td>
<td style="text-align: left;">Break</td>
</tr>
<tr class="odd">
<td>3:30 - 4:30</td>
<td style="text-align: left;">Afternoon Session 2</td>
</tr>
<tr class="even">
<td>4:30 - 5:00</td>
<td style="text-align: left;">Feedback and Development</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Each day concludes with a Q&amp;A and feedback session from 4:30-5:00, providing opportunities to clarify concepts and share ideas. It is expected that this first course will spur many new ideas and concepts which should be included in the future trainings. Please remember to take notes throughout each day with particular emphasis in areas you think could be explained better or that need additional topics covered. These can be areas that you struggled with or that you would anticipate could be difficult for others.</p>
<p>While the in-person version of this course was designed with the schedule outlined above, other users can easily navigate throughout the course content as desired, noting that the chapter content is designed for sequential learning.</p>
</section>
<section id="course-schedule" class="level2">
<h2 class="anchored" data-anchor-id="course-schedule">Course schedule</h2>
<section id="week-1" class="level3">
<h3 class="anchored" data-anchor-id="week-1">Week 1</h3>
<ul>
<li><strong>Day 1</strong>: MOSAIKS framework, accessing features, basic workflow</li>
<li><strong>Day 2</strong>: Understanding ground truth data, data cleaning, spatial resolution</li>
<li><strong>Day 3</strong>: Agricultural yield prediction, downloading features via API</li>
<li><strong>Day 4</strong>: Types of satellite imagery, processing considerations, quality control</li>
<li><strong>Day 5</strong>: Feature computation, theory behind RCFs, hands-on implementation</li>
</ul>
</section>
<section id="week-2" class="level3">
<h3 class="anchored" data-anchor-id="week-2">Week 2</h3>
<ul>
<li><strong>Day 1</strong>: <em>Martin Luther King Jr.&nbsp;Day - No Class</em></li>
<li><strong>Day 2</strong>: Model selection, hyperparameter tuning, cross-validation</li>
<li><strong>Day 3</strong>: Error analysis, confidence intervals, reporting uncertainty</li>
<li><strong>Day 4</strong>: Survey design principles, geolocation methods, sampling strategies</li>
<li><strong>Day 5</strong>: Advanced topics, emerging applications, future development</li>
</ul>
</section>
</section>
<section id="training-expectations" class="level2">
<h2 class="anchored" data-anchor-id="training-expectations">Training expectations</h2>
<section id="what-you-will-learn" class="level3">
<h3 class="anchored" data-anchor-id="what-you-will-learn">What you will learn</h3>
<ul>
<li>Understanding of MOSAIKS framework and capabilities</li>
<li>Practical skills in satellite imagery processing<br>
</li>
<li>Experience with machine learning applications</li>
<li>Hands-on practice with real-world datasets</li>
<li>Knowledge of survey data integration</li>
<li>Best practices for model implementation</li>
</ul>
</section>
<section id="prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<p>There are no explicit prerequisites, though this course does cover some advanced topics in:</p>
<ul>
<li>The <a href="https://www.python.org/" target="_blank"><code>Python</code></a> programming language</li>
<li>Machine learning</li>
<li>Geospatial data</li>
</ul>
</section>
<section id="participant-expectations" class="level3">
<h3 class="anchored" data-anchor-id="participant-expectations">Participant expectations</h3>
<ul>
<li>Active participation in discussions and hands-on sessions</li>
<li>Completion of assigned homework (particularly the Week 1 Friday assignment)<br>
</li>
<li>Engagement in Q&amp;A sessions</li>
<li>Contribution to feedback sessions for course improvement</li>
</ul>
</section>
<section id="computing-requirements" class="level3">
<h3 class="anchored" data-anchor-id="computing-requirements">Computing requirements</h3>
<p>The course includes hands-on computing sessions. You will need:</p>
<ul>
<li>A computer with access to the internet</li>
<li>A Google account</li>
<li>Access to Google Colaboratory</li>
<li>Access to necessary data (details to be provided)</li>
</ul>
</section>
<section id="homework-and-presentations" class="level3">
<h3 class="anchored" data-anchor-id="homework-and-presentations">Homework and presentations</h3>
<p>There will be a homework assignment at the end of Week 1, which participants will present on Tuesday of Week 2. This assignment is designed to reinforce learning and provide practical experience with MOSAIKS tools.</p>
</section>
</section>
<section id="book-structure-and-content" class="level2">
<h2 class="anchored" data-anchor-id="book-structure-and-content">Book structure and content</h2>
<p>This manual is organized into six main parts, each focusing on a critical aspect of MOSAIKS. We begin with foundational concepts and gradually progress to more advanced topics in modeling and uncertainty quantification.</p>
<div id="tbl-part-outline" class="striped hover quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-part-outline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Overview of the MOSAIKS Training Manual contents
</figcaption>
<div aria-describedby="tbl-part-outline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-striped table-hover caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 68%">
</colgroup>
<thead>
<tr class="header">
<th>Part</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Introduction</td>
<td style="text-align: left;">Computing setup, MOSAIKS overview, API access, initial demonstration</td>
</tr>
<tr class="even">
<td>Label data</td>
<td style="text-align: left;">Understanding suitable labels, survey integration, data preparation</td>
</tr>
<tr class="odd">
<td>Satellite imagery</td>
<td style="text-align: left;">Selecting appropriate imagery, processing considerations</td>
</tr>
<tr class="even">
<td>Features</td>
<td style="text-align: left;">Random convolutional features, API access, feature computation</td>
</tr>
<tr class="odd">
<td>Task modeling</td>
<td style="text-align: left;">Model selection, spatial analysis, temporal considerations</td>
</tr>
<tr class="even">
<td>Model uncertainty</td>
<td style="text-align: left;">Uncertainty quantification, ethical considerations</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The content is designed to be both comprehensive and practical, with each part building upon previous concepts while remaining relatively self-contained. This structure allows readers to either progress through the manual sequentially or focus on specific topics of interest. Throughout each section, we provide practical examples, code demonstrations, and best practices drawn from real-world applications.</p>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>MOSAIKS was developed and is supported by a large team of researchers across multiple partner organizations:</p>
<p><strong>Development Team:</strong></p>
<p>Benjamin Recht, Cullen Molitor, Darin Christensen, Esther Rolf, Eugenio Noda, Grace Lewin, Graeme Blair, Hannah Druckenmiller, Hikari Murayama, Ian Bolliger, Jean Tseng, Jessica Katz, Jonathan Proctor, Juliet Cohen, Karena Yan, Luke Sherman, Miyabi Ishihara, Shopnavo Biswas, Simon Greenhill, Solomon Hsiang, Steven Cognac, Tamma Carleton, Taryn Fransen, Trinetta Chong, Vaishaal Shankar</p>
<p><strong>MOSAIKS Training Manual Team:</strong> Cullen Molitor, Tamma Carleton, Esther Rolf, Sean Luna McAdams, Heather Lahr</p>
<p><strong>Partner Organizations:</strong></p>
<ul>
<li>Center for Effective Global Action (<a href="https://cega.berkeley.edu/">CEGA</a>; UCB)</li>
<li>Environmental Markets Lab (<a href="https://emlab.ucsb.edu/">emLab</a>; UCSB)</li>
<li>Global Policy Lab (<a href="https://www.globalpolicy.science/">GPL</a>; Stanford University)</li>
<li>Project on Resources and Governance (<a href="https://projectrg.org/">PRG</a>; UCLA)</li>
<li>Master of Environmental Data Science Program (<a href="https://bren.ucsb.edu/masters-programs/master-environmental-data-science">MEDS</a>; UCSB)</li>
</ul>
<p><strong>Funding Support:</strong></p>
<ul>
<li><a href="https://www.mcgovern.org/">The Patrick J. McGovern Foundation</a></li>
<li><a href="https://fundinnovation.dev/">The Fund for Innovation in Development (FID)</a></li>
<li><a href="https://www.usaid.gov/">The United States Agency for International Development (USAID)</a></li>
<li><a href="https://www.undp.org/">United Nations Development Programme (UNDP)</a></li>
</ul>
<p>We are grateful for the support and contributions of all team members and partner organizations in making MOSAIKS a reality. We hope to continue expanding the framework and its applications to address pressing global challenges.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Looking forward
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the first part of this book, we will cover the basics of MOSAIKS, including its framework, capabilities, and practical applications. This section is focused on exploring the original MOSAIKS publication (Rolf et al.&nbsp;2021) and understanding the core concepts behind the framework.</p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>